# Neco Weekly (2022-08-19号)

サイボウズ Neco チームでは、 Neco Weekly という「最近気になる Cloud Native 関連のネタを共有する会」を社内で開催しています。
本記事は共有会の中で紹介したネタをまとめたものです。

今回は第4回目の記事となります。

## ✨ New Features

###  Argo CD: Introduces Server-Side Apply as sync option

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/argoproj/argo-cd/pull/9711">feat: Introduces Server-Side Apply as sync option by leoluz · Pull Request #9711 · argoproj/argo-cd</a></h4><p>This PR implements the Server-Side Apply proposal. Achieved goals: [G-1] Fine grained configuration [G-2] Strategic merge patch while diffing [G-3] Admission Controllers compatibility [G-4] Conflict management [G-5] Register a proper manager Fix #2267 Fix #2268 Checklist: Either (a) I've created an enhancement proposal and discussed it with the community, (b) this is a bug fix, or (c) this does not need to be in the release notes.</p></blockquote>

Argo CD 2.5 でマニフェストを適用する際に Server-Side Apply [^1]方式が選べるようになります。

現在の Argo CD では、マニフェストを適用する際に Strategic Merge Patch 方式[^2]が利用されています。

Strategic Merge Patch 方式では、前回適用したマニフェストを annotation に保持しています。
そのため、 annotation に保存可能な 256KiB を超えるサイズのマニフェストを適用できないという問題がありました。
CRD や Grafana のダッシュボード設定ファイルは 256KiB を超えることも多く、Argo CD でこれらのマニフェストを扱うためには工夫が必要でした。

Sever-Side Apply 方式であれば 256KiB の制限はなくなり、1MiB 程度のマニフェストでも扱えるようになります。

とても欲しかった機能なのでリリースが待ち遠しいです。

[^1]: [Server-Side Apply](https://kubernetes.io/docs/reference/using-api/server-side-apply/)
[^2]: [Strategic Merge Patch](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md)


## 👀 Notable Articles

### For the love of god, stop using CPU limits on Kubernetes

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://home.robusta.dev/blog/stop-using-cpu-limits/">For the love of god, stop using CPU limits on Kubernetes</a></h4><p>Many people think you need CPU limits on Kubernetes but this isn't true. In most cases, Kubernetes CPU limits do more harm than help. I will explain why CPU limits are harmful with three analogies between CPU starved pods and thirsty explorers lost in a desert.</p></blockquote>

Kubernetes で Pod には CPU Limits を指定するなという主張です。

CPU Limits を指定すると、ノード単位では CPU に空きがあってもスロットリングが発生しパフォーマンスを劣化させるケースがあります。
一方で、CPU Requests を指定していれば、cgroup の `cpu.shares` (cgroup v2 では `cpu.weight`) により、最低限の CPU 割り当ては保証されます。
そのため、CPU Limits は指定せず、 CPU Requests のみを指定しておくのがよいと主張しています。

とはいえ、CPU Limits を指定しないと [Pod の QoS Class](https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/) を指定できず、CPU の占有（CPU Pinning）もできなくなってしまうので、単純に CPU Limits の指定をやめるというわけにはいきませんね。

## 📘 Books

### The BDD Books - Discovery

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://leanpub.com/bddbooks-discovery-jp">The BDD Books - Discovery (Japanese Edition)</a></h4><p>BDD/ATDDの第1ステップ：具体例を使って振る舞いを探索する この本は 100％完全です 本書籍は、振る舞い駆動開発(Behavior Driven Development, BDD)や受け入れテスト駆動開発(Acceptance Test-Driven Development, ATDD)の発見フェーズを最大限に活用する方法を提供します。 書籍内では、優れたコラボレーション手法を具体例で示しており、実用的なガイドとなっています。 本書籍は、SpecFlowの作成者と書籍『The Cucumber for Java Book』の著者によって書かれました。 本書籍は、プロダクトオーナー、ビジネスアナリスト、開発者、テスターなど、ソフトウェアの仕様とデリバリーに携わるすべての人を対象としています。 本書籍では、なぜBDDが誕生した理由の説明から始まり、ビジネスチームとデリバリーチームのメンバー間のコラボレーションを最大限に活用するためのテクニックを説明します。 これは、協調して作成した仕様と生きたドキュメントを活用して開発を成功させるために必要な特定の技術的なプラクティスを含む、開発プロセス全体をガイドするBDD Booksシリーズの1冊目です。 原著は こちら(Leanpubページ)もしくは こちら(Amazonページ) です Gáspár Nagy is the creator and main contributor of SpecFlow, the most widely used ATDD/BDD framework for .NET.</p></blockquote>

Neco チームでは、普段テストを書くときに [Ginkgo](https://onsi.github.io/ginkgo/) という BDD(Behavior Driven Development) フレームワークを使っているのですが、そういえば BDD についてちゃんと理解していないなと思い、この本を手に取りました。

この本によると、BDD はテスト手法ではなく、開発側とビジネス側が協調するための開発スタイルであるとのことでした。
Ginkgo を使っているだけでは BDD をやってるとは言えないということですね。
とはいえ、ユースケースを発見し、それを定式化して、自動テストに落とし込むというスタイルは、普段我々がおこなっている開発スタイルとも近いものがあり、参考になる点もいくつかありました。

ちなみに、我々が Ginkgo を選んだのは Kubebuilder が採用していたからなのですが、Kubebuilder では以下のような理由で Ginkgo を採用したようです。

https://github.com/kubernetes-sigs/kubebuilder/pull/952#issuecomment-532894264

## 🛠️ Tools, Frameworks, Libraries

### KUTTL

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://kuttl.dev">KUTTL</a></h4><p>The KUbernetes Test TooL (kuttl) ⇝ Get Started ⇜ Focus on your tests ... The KUbernetes Test TooL (KUTTL) is a highly productive toolkit for writing tests against Kubernetes operators and controllers. ... not on testing challenges Using KUTTL you can test Kubernetes applications, controllers and operators in a cluster environment, using YAML the way you already know.</p></blockquote>

Kubernetes Operator をテストするためのツール。
入力となるマニフェスト、Kubernetes オブジェクトに対する操作、期待する結果をすべて YAML 形式で宣言的に書くことができるようです。

実際に使ってみないと使い勝手は分かりませんが、簡易的なテストを書きたい場合には便利なのかもしれません。

## 🤝 Events

### CloudNative Security Conference 2022

- [Simplify Cloud Native Security with Trivy](https://speakerdeck.com/knqyf263/simplify-cloud-native-security-with-trivy/)
  - Trivy によるセキュリティ対策の話
  - Trivy ってコンテナイメージのセキュリティチェックツールだと思ってたんですが、それ以外にもいろんなスキャンができると知って驚きました。
- [eBPFで実現するコンテナランタイムセキュリティ](https://speakerdeck.com/tobachi/container-runtime-security-with-ebpf)
  - eBPF の基本的なところから丁寧に解説されていました。

### Black Hat 2022

- [Blackhat 2022の総括 -トレンドとハイライト](https://sysdig.jp/blog/blackhat-2022-recap/)
- [Return to sender Detecting kernel exploits with eBPF](https://i.blackhat.com/USA-22/Wednesday/US-22-Fournier-Return-To-Sender.pdf)
  - eBPFを使って Kernel Exploit を検知する話。
  - 攻撃者が脆弱性を利用してカーネルに侵入したら eBPF を無効化する方法はいくつもあるし、パフォーマンスへの影響も大きい。

最近は様々な分野で eBPF が利用されはじめていますが、[2022-08-05号](2022-08-05.md)で紹介したようにサービスメッシュのサイドカーレス方式に関する問題などもありましたし、どこでも利用できる万能の技術ではないんだなあという感想を持ちました。

## あとがき

8月22日から、サイボウズサマーインターン2022 Kubernetes基盤コースが始まります。
このインターンの学生さん向けにGinkgo/Gomegaを利用したKubernetes Operatorのテスト手法について書きました。

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://zenn.dev/zoetro/books/testing-kubernetes-operator">Ginkgo/GomegaによるKubernetes Operatorのテスト手法</a></h4><p>本書では、テスティングフレームワークであるGinkgoとGomegaを利用したKubernetes Operatorのテスト手法について解説します。</p></blockquote>

学生さん向けとは言いつつも、面白いネタもいくつか紹介しているので、ぜひご覧ください。
