# Neco Weekly (2022-08-05号)

サイボウズ Neco チームでは、 Neco Weekly という「最近気になる Cloud Native 関連のネタを共有する会」を社内で開催しています。
本記事は共有会の中で紹介したネタをまとめたものです。

今回は第3回目の記事となります。

## ✨ New Features

### Kubebuilder v3.6.0

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/kubernetes-sigs/kubebuilder/releases/tag/v3.6.0">Release Release v3.6.0 · kubernetes-sigs/kubebuilder</a></h4><p>(go/v3, go/v4-alpha): upgrade gcr.io/kubebuilder/kube-rbac-proxy from v0.12.0 to v0.13.0 (#2803) (kustomize/v2-alpha): remove unnecessary varReference for setup cert-manager (#2794) (go/v3, go/v4-alpha): upgrade k8s deps from 1.24 to 1.24.2, controller-tools from v0.9.0 to v0.9.2 and controller-runtime from v0.12.1 to v0.12.2 (#2791) (for external plugins/phase 2 plugins): enable external plugins to specify metadata and</p></blockquote>

Kubebuilder v3.6.0 がリリースされました。
今回は新しいプラグインが追加されています。

`grafana` プラグインを利用すると、カスタムコントローラーから収集したメトリクスを表示するための Grafana ダッシュボードが生成できるようです。

`deploy.image` プラグインを利用すると、「カスタムコントローラーの環境変数にコンテナイメージ名を指定し、
Deployment や StatefulSet などを生成する際に指定されたコンテナイメージを利用する」ためのコードが生成されるようです。

Kubebuilder は今後こういった形のプラグインがどんどん増えていくのかもしれませんね。

### KEP-2091: Add support for AdminNetworkPolicy resources

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-network/2091-admin-network-policy/README.md">enhancements/README.md at master · kubernetes/enhancements</a></h4><p>Items marked with (R) are required prior to targeting to a milestone / release. Introduce new set of APIs to express an administrator's intent in securing their K8s cluster. This doc proposes the AdminNetworkPolicy API to complement the developer focused NetworkPolicy API in Kubernetes. Kubernetes provides the NetworkPolicy resource to control traffic within a cluster.</p></blockquote>

AdminNetworkPolicy というリソースに関する KEP （Kubernetes Enhancement Proposal: Kubernetesの新機能提案）です。

これまでの NetworkPolicy リソースでは、マルチテナント環境において適切なポリシーを設定することが難しいという問題があります。
例えば、以下のようなポリシーを実現することは簡単ではないでしょう。

- クラスタ管理者として絶対に守ってもらいたいポリシーを定義する。クラスタの利用ユーザーはポリシーの上書きはできない。
- クラスタ管理者としてデフォルトのポリシーを定義する。クラスタの利用ユーザーは必要に応じてポリシーを上書きできる。
- 1 つのテナントが複数の namespace を利用している場合、テナント間のネットワークを分離するためのポリシーを定義する。

これらの問題をどのように解決すればいいのでしょうか？

例えば [Calico](https://projectcalico.docs.tigera.io/reference/cni-plugin/configuration) の NetworkPolicy には Order というフィールドがあり、
ポリシーごとの優先順位を指定することができます。
そして Admission Webhook を利用してテナントユーザーが書き換え可能な Order を制限すれば、ポリシーの上書きが可能かどうかを制御することができるでしょう。

一方 [Cilium](https://cilium.io) の NetworkPolicy には、優先順を設定するような仕組みはありません。
そこで Neco チームでは [Tenet](https://github.com/cybozu-go/tenet) という OSS を開発し、この問題を解決していました。

この KEP は AdminNetworkPolicy という新しいリソースを導入し、上記のような問題点を解決しようという提案です。

`Priority` で優先順位を制御できたり、 `Pass` という `Action` を指定することでテナントユーザーがポリシーを書き換え可能にしたり、
`NamespaceSelector` により複数の Namespace にマッチするポリシーを書くことができたりするようです。

必要な機能がしっかりと盛り込まれていて、導入されるのが非常に待ち遠しいですね。

なお、Calico にはすでに対応のための Issue が立てられていました。

- https://github.com/projectcalico/calico/issues/5891

## 📘 Books

### Go言語による分散サービス

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://www.oreilly.co.jp/books/9784873119977/">Go言語による分散サービス</a></h4><p>TOPICS Programming 発行年月日 2022年08月 PRINT LENGTH 280 ISBN 978-4-87311-997-7 原書 Distributed Services with Go FORMAT Print PDF EPUB 本書への推薦の言葉 はじめに 第I部　さあ始めましょう 　 1章　レッツGo 1.1　HTTPベースのJSONサービスの分散システムへの適合性 1.2　プロジェクトの準備 1.3　コミットログのプロトタイプの作成 1.4　HTTPベースのJSONサーバの構築 1.5　サーバの実行 1.6　APIのテスト 1.7　学んだこと 2章　プロトコルバッファによる構造化データ 2.1　プロトコルバッファを使う理由 2.2　プロトコルバッファのコンパイラをインストール 2.3　レコード型をプロトコルバッファとして定義 2.4　プロトコルバッファのコンパイル 2.5　生成されたコードの扱い 2.6　学んだこと 3章　ログパッケージの作成 3.1　ログは強力なツール　 3.2　ログの仕組み 3.3　ログの構築 3.3.1　ストアのコーディング 3.3.2　インデックスの作成 3.3.3　セグメントの作成 3.3.4　ログのコーディング 3.4　学んだこと 第II部　ネットワーク 　 4章　gRPCによるリクエスト処理 4.1　gRPCとは何か</p></blockquote>

gRPC, サービスディスカバリ、分散合意などをコードを元に解説しながら分散システムを実装するという内容の書籍です

サービスディスカバリには Serf を利用し、分散合意のためには Raft をライブラリとして利用しているので、難易度はそれほど高くないと思います。
非常に丁寧にコードを解説しているので、分散システムを学ぶための入門書としてとてもよさそうです。

Necoチームでは、Serf を利用してノードの死活監視をおこなったり、etcd を利用して分散システムを開発したりしているので、チーム必読の書籍とも言えそうです。

コードは以下のリポジトリで公開されています。

- https://github.com/YoshikiShibata/proglog

本書は基本的には文字とコードのみで解説していて、図はほとんど出てきません。
また Serf や Raft の説明もそこまで詳しく書かれているわけではありません。
理論をしっかりと学びたい場合は「[データ指向アプリケーションデザイン](https://www.oreilly.co.jp/books/9784873118703/)」なども併せて読むのがおすすめです。

また、少し古いですが以下の記事も併せて読むと理解が深まると思います。

- [自動障害回復システム 月読の話](https://blog.cybozu.io/entry/5799)

## 🤝 Events

### KubeCon + CloudNativeCon North America 2022

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://events.linuxfoundation.org/kubecon-cloudnativecon-north-america/program/schedule/">Schedule | Linux Foundation Events</a></h4><p>All keynotes and sessions will be recorded. Session recordings will be available in the CNCF YouTube channel in early November. The Sched app allows you to build your schedule but is not a substitute for your event registration. You must be registered for KubeCon + CloudNativeCon North America 2022 to participate in the sessions.</p></blockquote>

10 月に開催される KubeCon NA のスケジュールが公開されていたので、個人的に気になるセッションをピックアップしてみました。

- [API Evolution With CRDs: Best Practices For Authoring & Fuzz Testing APIs](https://kccncna2022.sched.com/event/182HR/api-evolution-with-crds-best-practices-for-authoring-fuzz-testing-apis-james-munnelly-andrea-tosatto-apple?iframe=no&w=100%&sidebar=yes&bg=no)
- [Running Isolated VirtualClusters With Kata & Cluster API](https://kccncna2022.sched.com/event/182I4/running-isolated-virtualclusters-with-kata-cluster-api-chris-hein-eric-ernst-apple-inc?iframe=no&w=100%&sidebar=yes&bg=no)
- [Beyond Kubebuilder - Generating Entire Kubernetes Controller Implementations](https://kccncna2022.sched.com/event/182Hd/beyond-kubebuilder-generating-entire-kubernetes-controller-implementations-amine-hilaly-jay-pipes-amazon-web-services?iframe=no&w=100%&sidebar=yes&bg=no)
- [How To Write a Reconciler Using K8s Controller-Runtime!](https://kccncna2022.sched.com/event/182Hg/how-to-write-a-reconciler-using-k8s-controller-runtime-scott-rigby-himangini-daware-soule-ba-weaveworks?iframe=no&w=100%&sidebar=yes&bg=no)
- [Webhook Fatigue? You're Not Alone: Introducing the CEL Expression Language Features Solving This Problem](https://kccncna2022.sched.com/event/182Q6/webhook-fatigue-youre-not-alone-introducing-the-cel-expression-language-features-solving-this-problem-joe-betz-google?iframe=no&w=100%&sidebar=yes&bg=no)
- [Towards Something Better Than CRDs In a Post-Operator World](https://kccncna2022.sched.com/event/182Hm/towards-something-better-than-crds-in-a-post-operator-world-stefan-schimanski-red-hat?iframe=no&w=100%&sidebar=yes&bg=no)
- [Multi-Tenancy: Tips, Tricks, Tools And Tests](https://kccncna2022.sched.com/event/182O4/multi-tenancy-tips-tricks-tools-and-tests-tasha-drew-vmware-jim-bugwadia-nirmata-ryan-bezdicek-twilio-fei-guo-alibaba?iframe=no&w=100%&sidebar=yes&bg=no)
- [Multi-Tenancy For Argo Workflows And Argo CD At Adobe](https://kccncna2022.sched.com/event/182Fw/multi-tenancy-for-argo-workflows-and-argo-cd-at-adobe-srinivas-malladi-adobe?iframe=no&w=100%&sidebar=yes&bg=no)
- [Run As “Root”, Not Root: User Namespaces In K8s](https://kccncna2022.sched.com/event/182K0/run-as-root-not-root-user-namespaces-in-k8s-marga-manterola-isovalent-rodrigo-campos-catelin-microsoft?iframe=no&w=100%&sidebar=yes&bg=no)
- [Class Resources: Kubernetes' Fastest Way Of Shushing Noisy Neighbors](https://kccncna2022.sched.com/event/182JQ/class-resources-kubernetes-fastest-way-of-shushing-noisy-neighbors-markus-lehtonen-intel-peter-hunt-red-hat?iframe=no&w=100%&sidebar=yes&bg=no)
- [SLO-Based Observability For All Kubernetes Cluster Components](https://kccncna2022.sched.com/event/182G2/slo-based-observability-for-all-kubernetes-cluster-components-matthias-loibl-polar-signals-nadine-vehling-grafana-labs?iframe=no&w=100%&sidebar=yes&bg=no)
- [Fast Image Pulls Using IPFS And Opportunistic Caching](https://kccncna2022.sched.com/event/182JW/fast-image-pulls-using-ipfs-and-opportunistic-caching-christian-weichel-manuel-de-brito-fontes-gitpod?iframe=no&w=100%&sidebar=yes&bg=no)
- [Cgroupv2 Is Coming Soon To a Cluster Near You](https://kccncna2022.sched.com/event/182JZ/cgroupv2-is-coming-soon-to-a-cluster-near-you-david-porter-google-mrunal-patel-redhat?iframe=no&w=100%&sidebar=yes&bg=no)
- [Content Addressable CRDs: Type Uniqueness Across Kubernetes Clusters](https://kccncna2022.sched.com/event/182DE/content-addressable-crds-type-uniqueness-across-kubernetes-clusters-daniel-mangum-upbound?iframe=no&w=100%&sidebar=yes&bg=no)

面白そうなセッションが盛りだくさんで楽しみですね！

## 👀 Notable Articles

### eBPF, sidecars, and the future of the service mesh

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://buoyant.io/blog/ebpf-sidecars-and-the-future-of-the-service-mesh">eBPF, sidecars, and the future of the service mesh</a></h4><p>eBPF is cool technology with a lot to offer the cloud native world. It's been a popular choice for the CNI layer of Kubernetes clusters thanks to projects like Cilium. Service meshes like Linkerd are often deployed with CNI layers like Cilium, combining Linkerd's powerful L7 processing with Cilium's ...</p></blockquote>

[2022-07-22号](./../07/2022-07-22.md) でも軽く触れましたが、サービスメッシュを実現する際に、
サイドカーとしてアプリケーションごとにプロキシを立てるのか、ホストごとにプロキシを立てるのか、プロキシなしなのか、
どの方式が良いのかを解説している記事です。

この記事ではサイドカー方式がよいという結論ですが、eBPF の技術的な制限や、Linkerd v1 の反省に基づいて解説しているので、非常に説得力の高い内容となっています。

## 🛠️ Tools, Frameworks, Libraries

### Goodbye Sealed Secrets, hello SOPS

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://itnext.io/goodbye-sealed-secrets-hello-sops-3ee6a92662bb">Goodbye Sealed Secrets, hello SOPS</a></h4><p>We assume that you are on Windows and using WSL as Linux environment. We will setup Sops in both. Want to dive right in? Click here to jump directly to the installation section. Installation covers: Sops is a binary able to encrypt configuration files.</p></blockquote>

SealedSecret にはいくつか問題があるので、代わりに SOPS はどうかと紹介している記事です。

SOPS には以下のような特徴があるそうです。

- リソース全体を暗号化するのではなく指定したフィールドの値のみを暗号化できる
- 1 バイナリとして動くので、カスタムコントローラーをデプロイする必要がない

1 バイナリとして動くので、Argo CD のような CD ツールでデプロイする際には一工夫必要になりそうですね。

### Metacontroller

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://metacontroller.github.io/metacontroller/intro.html">Metacontroller</a></h4><p>Metacontroller is an add-on for Kubernetes that makes it easy to write and deploy custom controllers. Although the open-source project was started at Google, the add-on works the same in any Kubernetes cluster. While custom resources provide storage for new types of objects, custom controllers define the behavior of a new extension to the Kubernetes API.</p></blockquote>

先に紹介した「Go言語による分散サービス」の中で登場したので調べてみました。

これは、カスタムリソースと簡単なスクリプトを書くだけでカスタムコントローラーがデプロイできてしまうというものです。
スクリプトは、Jsonnet, Go, Java などの言語で書けるようです。

自分たちでカスタムコントローラーを実装するのに比べると制約は多そうですが、ちょっとしたコントローラーを手軽に作りたいときには便利かも知れませんね。

### Why and How to Use containerd From Command Line

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://iximiuz.com/en/posts/containerd-command-line-clients/">Why and How to Use containerd From Command Line</a></h4><p>containerd is a high-level container runtime, aka container manager. To put it simply, it's a daemon that manages the complete container lifecycle on a single host: creates, starts, stops containers, pulls and stores images, configures mounts, networking, etc. containerd is designed to be easily embeddable into larger systems. Docker uses containerd under the hood to run containers.</p></blockquote>

containerd のコマンドラインツールの選択肢として ctr, nerctl, crictl がありますが、それらの比較をしている記事です。

- ctr: containerd の API をそのまま叩いてる。ユーザーフレンドリーではないがデバッグや学習用とで役立つ。
- nerdctl: Docker 互換を目指している。stargz や ipfs などの containerd の新機能が利用できる。
- crictl: CRI API に対応したツール。

## あとがき

NecoWeekly を始めて一番よかったことは、これまで後で読もうと思って溜め込んでいた記事をちゃんと読むようになったことです。
