# Neco Weekly (2022-07-22号)

<script async src="//cdn.embedly.com/widgets/platform.js" charset="UTF-8"></script>

サイボウズ Neco チームでは、 Neco Weekly という「最近気になる Cloud Native 関連のネタを共有する会」を社内で開催しています。

この共有会の中で紹介したネタをここで社外発信していこうと思います。

今回は第1回目の記事となります。

## Neco チームとは

Neco チームは、 Kubernetes を主要な部品として、自社クラウドサービス cybozu.com を運用するためのデータセンター管理基盤の開発および運用をおこなっています。

チームの取り組みに興味がある方は、ぜひ以下のページをご覧ください。

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/cybozu-neco">cybozu-neco - Overview</a></h4><p>A machine account for Neco. cybozu-neco has 3 repositories available. Follow their code on GitHub.</p></blockquote>

## ✨ Release Notes

### Loki v2.6.0 リリース

<blockquote class="embedly-card"><h4><a href="https://github.com/grafana/loki/releases/tag/v2.6.0">Release v2.6.0 · grafana/loki</a></h4><p>Query multiple tenants at once. We've introduced cross-tenant query federation, which allows you to issue one query to multiple tenants and get a single, consolidated result. This is great for scenarios where you need a global view of logs within your multi-tenant cluster. For more information on how to enable this feature, see Multi-Tenancy.</p></blockquote>

Loki v2.6.0 がリリースされました。

これまでは長期間のログを指定したクエリの実行にとても時間がかかっていたのですが、クエリを30分ごとの小さなクエリに分割して並列実行するようになるそうです。

性能向上が期待できそうでとても楽しみです。

### Cilium 1.12 リリース

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://isovalent.com/blog/post/cilium-release-112/">Cilium 1.12 - Ingress, Multi-Cluster, Service Mesh, External Workloads, and much more</a></h4><p>Today, we are excited to announce the release of Cilium 1.12. This is yet another massive release. While writing this blog, we have jokingly mentioned that we will soon have to publish the release blog as a book.</p></blockquote>

Cilium は活発に開発が進められており、今回のリリースノートはかなり膨大なものになっています。
Ingress や Service Mesh などたくさんの新機能が実装されており、Cilium はただの CNI 実装のひとつではなく、大きなネットワークエコシステムを目指しているように思えます。

今回は、リリースノートの中からいくつか気になるものをピックアップしてみます。

- Sidecar-free datapath option: 
    - Istio などのサービスメッシュ実装ではサイドカー方式が採用されているのですが、Cilium ではサイドカーなし方式がオプションとして選べるようになったとのこと。
    - 実装の複雑さや性能面でそれぞれメリット・デメリットがあり、どちらの方式がよいのか議論になっているようなので、少し様子を見守りたいところです。
- Egress Gateway promoted to Stable: 
    - Neco チームとしても Egress Gateway 機能を利用したいと考えています。しかし現状は HA 構成ではないためプロダクションで利用するのはちょっと難しいかもしれません。
- Improved BGP control plane: 
    - IPv6 対応のために MetalLB から GoBGP に置き換えていくことを決定。
    - Neco チームではロードバランサーの VIP を広告するために MetalLB を利用しているが、そこはまだ GoBGP に置き換えられていない模様。今後 MetalLB から GoBGP への置き換えが必要になりそうなので要注目。
- Improved Multi-Homing for Load Balancer: 
    - これまで複数のデバイスを持つノードで正しく経路が選択されていなかったがこれが改善された。これは Neco チームがコントリビュートしたものになります。

また、Neco チームでは現在 Cilium への移行を進めており、その中でかなりの数の不具合を見つけています。
今回のリリースでは、なんと7件もの PR が取り込まれました🎉🎉🎉

- bgp: Check the Condition.Ready field when adding ready endpoints ([#20176](https://github.com/cilium/cilium/pull/20176), @ysksuzuki)
- daemon: Support the wildcard option for directRoutingDevice ([#17930](https://github.com/cilium/cilium/pull/17930), @ysksuzuki)
- bpf: Fix maglev hash with hostServices.hostNamespaceOnly ([#18336](https://github.com/cilium/cilium/pull/18336), @ysksuzuki)
- endpoint: Fix packets to host dropped with the chaining mode and host firewall ([#19734](https://github.com/cilium/cilium/pull/19734), @ysksuzuki)
- docs: Fix incorrect values for hubble-ui standalone install ([#18661](https://github.com/cilium/cilium/pull/18661), @ysksuzuki)
- neigh: Support multi device neighbor discovery (Backport PR [#20333](https://github.com/cilium/cilium/pull/20333), Upstream PR [#20092](https://github.com/cilium/cilium/pull/20092), @ysksuzuki)
- test: Fix make target for k8s tests (Backport PR [#20401](https://github.com/cilium/cilium/pull/20401), Upstream PR [#20264](https://github.com/cilium/cilium/pull/20264), @ysksuzuki)

## 👀 Notable Articles

### Kubernetes の Gateway API が beta に

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://kubernetes.io/blog/2022/07/13/gateway-api-graduates-to-beta/">Kubernetes Gateway API Graduates to Beta</a></h4><p>Authors: Shane Utt (Kong), Rob Scott (Google), Nick Young (VMware), Jeff Apple (HashiCorp) We are excited to announce the v0.5.0 release of Gateway API. For the first time, several of our most important Gateway API resources are graduating to beta.</p></blockquote>

<blockquote class="embedly-card"><h4><a href="https://www.groundcover.com/blog/k8s-gateway-api">K8s Gateway API is here - what's in it for you?</a></h4><p>Yesterday (July 13th, 2022), the Kubernetes SIG-Network announced version 0.5.0 of the much anticipated Gateway API. What is so special about this release you ask? It's that finally, major components of the api are graduating to beta (v1beta1) - which means we will soon start to see more projects using those primitives - and they might even be good enough for the early adopters among us to give them a try.</p></blockquote>

Kubernetes の Ingress API の後継として開発が進められている Gateway API がついにベータとなりました。

Gateway API は Ingress API と比べて様々なメリットがあります。

- リソース作成の役割分担が明確（管理者が Gateway/GatewayClass を作成し、アプリ開発者が HTTPRoute を作成するなど）
- Ingress リソースは表現力が乏しく設定をアノテーションで書く必要があったが、Gateway API ではきちんと API の設計がおこなわれている。
- Namespace をまたがったルーティング設定が可能

Neco では L7LB として [Contour](https://projectcontour.io) を採用し、サービスをクラスタ外に公開するために [HTTPProxy](https://projectcontour.io/docs/v1.20.1/config/fundamentals/) というカスタムリソースを利用しています。

Contour はすでに Gateway API に対応しているようです。

- [Using Gateway API (v1alpha2) with Contour](https://projectcontour.io/guides/gateway-api/)

今後、HTTPProxy から Gateway API への置き換えが発生することを考えるとやや気が重たいですね🙁

## 📘 Books

### ピアリング戦記

Neco チームでは[データセンターネットワークの実装に BGP を利用](https://blog.cybozu.io/entry/bgp-basics)しているということもあり、最近話題になっているピアリング戦記を読んでみました。

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://www.lambdanote.com/products/peering">ピアリング戦記 ― 日本のインターネットを繋ぐ技術者たち</a></h4><p>「ネットワークのネットワーク」って、こういう意味だったんだ！ 技術的な仕様の解説だけでは語れない、人と人を繋ぐネットワーク技術だからこそ立ち現れる生々しい舞台裏を、2020年代の日本のインターネットの大規模構造に影響をもたらした当事者たちへの取材とインタビューをとおして解き明かす！ 小川晃通 著 150ページ A5判 2022年7月13日 発行 第1章 ピアリングを巡る静かな戦い 第2章 データセンターとその立地 第3章 IXとは何か? 国ごとに違うIX 第4章 ピアリング相手の探し方 第5章 コンテンツ事業者の台頭</p></blockquote>

日本のインターネットがどのように構築されてきたのかという歴史を、たくさんのインタビューを通じて知ることができるとても面白い一冊でした。

## 🛠️ Frameworks, Libraries

### Connect: A better gRPC

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://buf.build/blog/connect-a-better-grpc">Connect: A better gRPC</a></h4><p>Today we're releasing Connect, a slim framework for building browser and gRPC-compatible HTTP APIs. Connect is production-ready - focused, simple, and debuggable - and it's fully compatible with gRPC clients and servers. If you're frustrated by the complexity and instability of today's gRPC libraries, we think you'll find Connect a breath of fresh air.</p></blockquote>

これまで広く使われてきた gRPC の Go 実装は [grpc-go](https://github.com/grpc/grpc-go) です。
grpc-go は自前で HTTP/2 を実装しているため Go の HTTP のエコシステムが利用できなかったり、JavaScript から gRPC のサービスを呼び出すためにプロキシが必要だったり、いくつかの問題があります。

それらを解決するために Connect という新しい gRPC の実装が登場したようです。

Connect は現在ベータ版とのことですが、2022年10月には安定版のリリースが予定されているようです。
今後は gRPC 実装の一つの選択肢として検討してみてもいいかもしれませんね。

なお、Neco チームでは [MOCO](https://github.com/cybozu-go/moco) や [Coil](https://github.com/cybozu-go/coil) の実装で gRPC を利用しています。

gRPC に興味がある方は、ぜひ以下のチュートリアルもご覧ください。

- [gRPC チュートリアル](https://github.com/ymmt2005/grpc-tutorial)

## おわりに

Neco Weekly の取り組みは [Cybozu Frontend Weekly](https://cybozu.github.io/frontend-expert/posts), [Productivity Weekly](https://zenn.dev/topics/productivityweekly) を参考にして始めました。

Cybozu Frontend Weekly や Productivity Weekly と同じ様に、長く続けていければいいなと思っています。
