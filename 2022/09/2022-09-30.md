# Neco Weekly (2022-09-30号)

サイボウズ Neco チームでは、 Neco Weekly という「最近気になる Cloud Native 関連のネタを共有する会」を社内で開催しています。
本記事は共有会の中で紹介したネタをまとめたものです。

今回は第9回目の記事となります。

## 👀 Notable Articles

### Under-documented Kubernetes Security Tips

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://www.macchaffee.com/blog/2022/k8s-under-documented-security-tips/">Under-documented Kubernetes Security Tips</a></h4><p>Securing Kubernetes is complex, so there are quite a few guides out there: Unfortunately, following all those guides and patching every CVE still might not be enough. There are some security practices which kinda don't fit into these guides, don't get reported as CVEs, and just exist in the minds of expensive consultants.</p></blockquote>

文書化されていない Kubernetes のセキュリティに関する注意点を紹介している記事です。

特に2つめにあげられている「The Kubernetes API has undocumented verbs and subresources」は我々も注意しなければならないと感じました。
たとえば Admission Webhook でコンテナの設定に制限をかけていた場合でも、 Ephemeral Container に対する制限をかけ忘れているケースはよくありそうです。

なお、Ephemeral Container に対するセキュリティ対策については、以下の記事も参考になります。

- [Kubernetes Ephemeral Container Security](https://xenitab.github.io/blog/2022/04/12/ephemeral-container-security/)

### Kubernetes 1.25: CustomResourceDefinition Validation Rules Graduate to Beta

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://kubernetes.io/blog/2022/09/23/crd-validation-rules-beta/">Kubernetes 1.25: CustomResourceDefinition Validation Rules Graduate to Beta</a></h4><p>Authors: Joe Betz (Google), Cici Huang (Google), Kermit Alexander (Google) In Kubernetes 1.25, Validation rules for CustomResourceDefinitions (CRDs) have graduated to Beta! Validation rules make it possible to declare how custom resources are validated using the Common Expression Language (CEL). For example: apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition ...</p></blockquote>

Kubernetes 1.25 で、Common Expression Language (CEL) という記法で CRD のバリデーションができる機能が Beta になりました。
この機能を使うと、Admission Webhook を実装しなくてもある程度柔軟に CRD のバリデーションを設定することが可能になります。

この機能を試してみた記事が以下になります。

- [Kubernetes 1.25でbetaになったCommon Expression Language (CEL)を試してみる](https://zenn.dev/zoetro/scraps/30eabefe3545d4)

さらに、フィールドを Immutable にしたり、リストやマップに対して要素の追加のみを可能にする例が以下のブログで紹介されています。

- [Enforce CRD Immutability with CEL Transition Rules](https://kubernetes.io/blog/2022/09/29/enforce-immutability-using-cel/)

### NGINXの運用をちょっとだけ楽にするKubernetes Controllerを実装してみた

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://zenn.dev/junya0530/articles/97b8926799b755">NGINXの運用をちょっとだけ楽にするKubernetes Controllerを実装してみた</a></h4><p>以前[Controller編] Server-Side Applyを試す の記事にて、Server-Side Apply（以降SSA）を試してみました。 そこで、今回はSSAを利用して、NGINXの運用をちょっとだけ楽にするControllerを実装してみました。また、Controllerで利用可能なさまざまな機能も色々と盛り込んでいるので、今後のチュートリアル的な出来になったかなと思います。 以下のリポジトリにコードを配置しています。 以下の作業を自動化します。 以下のkuberndtes　Resourceを作成する。 ConfigMap: default.confとindex.html Deployment: NGINXサーバー Service: NGINXへのルーティングを行う Ingress: 外部からのアクセスをServiceにルーティングする Secret: IngressのSSL終端に必要なCA証明書、サーバー証明書、サーバー証明書の秘密鍵が含まれる Secret: Ingressへのアクセスに必要なクライアント証明書と秘密鍵が含まれる Resource名の変更 名称変更後、旧Resourceを削除 Resource定義の変更 default.conf変更時の自動再読み込み (inotifywaitで監視) まずCustomResource定義を準備します。 CustomResourceを適用することで、以下のように各Resourceが自動作成されます。 $ kubectl -n ssa-nginx-controller-system get all,cm,secret,ingress NAME READY STATUS RESTARTS AGE pod/nginx-686484b946-bnhgc 1/1 Running 0 32m pod/nginx-686484b946-fhx4c 1/1 Running 0 32m pod/nginx-686484b946-kzgpc</p></blockquote>

Server-Side Apply を利用したカスタムコントローラの実装を紹介している記事です。
まだまだ Server-Side Apply を活用した事例というのは少ないので、こうやって事例が増えていくのは良いですね。

### インターンシップ

PFN さんとメルカリさんのインターンシップの成果を報告している記事です。

- [Kubernetesにおけるコンテナ起動時間高速化に向けた検討](https://tech.preferred.jp/ja/blog/i22-k8s-accelerating-container-startup/)
- [Kubernetes Threat Matrixの再構築およびFalcoによる攻撃検知の検証](https://engineering.mercari.com/blog/entry/20220928-kubernetes-threat-matrix-and-attack-detection-by-falco/)

Neco チームでも IPFS の導入やセキュリティ対策の強化を検討しているため、非常に興味深い内容でした。

## 🤝 Events

### ArgoCon 2022: Attacking Argo CD with Argo CD (and then Defending)

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://www.youtube.com/watch?v=bRNMI29F2fI">Attacking Argo CD with Argo CD (and then Defending) - Michael Crenshaw, Intuit</a></h4><p>null</p></blockquote>

先日開催された ArgoCon 2022 の中で興味深かったセッションの紹介です。

このセッションでは、Argo CD の設定を Argo CD で管理しているケースにおいて、攻撃者に設定を書き換えられてしまう問題とその対策を紹介しています。

対策としては、AppProject リソースの `sourceRepos` や `destinations` を正しく設定することや、Argo CD の RBAC 機能を正しく利用することが大事だと説明されています。
また、Argo CD 2.5 で導入される以下の新機能についても軽く触れられていました。

- [feat: add deny destinations for projects](https://github.com/argoproj/argo-cd/pull/9652)
- [feat: Applications in any namespace](https://github.com/argoproj/argo-cd/pull/9755)

さらに後半では、App-of-Apps パターンにおいてユーザーが任意のプロジェクトを指定できてしまう問題や、ユーザーが AppProject を自由に作成できない問題が取り上げられていました。
現状ではレビューでチェックするしかないということでした。

ちなみに、Neco チームでは [Cattage](https://github.com/cybozu-go/cattage) という OSS を開発し、App-of-Apps パターンにおける権限の問題を解決しています。

## ✨ Release Notes

### Trivy Operator v0.2.0

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://twitter.com/ChenKeinan/status/1570432959525834752">Chen Keinan on Twitter: "Trivy Operator v0.2.0 Released !!https://t.co/1Y9gbKTZbBMore Protection for your k8s cluster, now support.- Scan Kubernetes resources for deprecated and removal APIs- Webhook integration for sending reports externally via SOAR tool Postee to ServiceNow, Slack and many more / Twitter"</a></h4><p>Trivy Operator v0.2.0 Released !!https://t.co/1Y9gbKTZbBMore Protection for your k8s cluster, now support.- Scan Kubernetes resources for deprecated and removal APIs- Webhook integration for sending reports externally via SOAR tool Postee to ServiceNow, Slack and many more</p></blockquote>

Trivy Operator v0.2.0 がリリースされました。
Deprecated や削除された API の利用を検出できたり、Webhook を使って検出結果を通知できるようになったそうです。
これはかなり便利そう。

### Kubebulder v3.7.0

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/kubernetes-sigs/kubebuilder/releases/tag/v3.7.0">Release v3.7.0 · kubernetes-sigs/kubebuilder</a></h4><p>changes since v3.6.0 add options and guidance to provide solutions for other platforms and within multiple architecture support (#2906) (go/v3, go/v4-alpha and declarative/v1): Update k8s deps by upgrading controller-runtime from v0.12.2 to 0.13.0 and kubebuilder-declarative-pattern from fe5be9431eae158f86f9de23000a9a2ec06745fc to e0605f0e1a40f97293cb3773f57de695c8bc76af (#2920) add support to go 1.19 (#2922) Update envtest version (1.24.2</p></blockquote>

新しい機能が多く含まれていますが、特に以下の3つに注目です。

- 生成するプロジェクトがマルチアーキテクチャ対応した
- カスタムメトリクス用の Grafana ダッシュボードを生成できるようになった
- 生成するマニフェストのラベルが Kubernetes 推奨の形式に変更された

### controller-tools v0.10.0

https://github.com/kubernetes-sigs/controller-tools/releases/tag/v0.10.0

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/kubernetes-sigs/controller-tools/releases/tag/v0.10.0">Release Release v0.10.0 · kubernetes-sigs/controller-tools</a></h4><p>changes since v0.9.2 crdgen: compare metav1 pkg by ID by @akutz in #681 Allow setting PreserveUnknownFields at both type and field level by @eddycharly in #689 Add XPreserveUnknownFields to runtime.RawExtension by @eddycharly in #683 Make topology markers also valid for type definitions by @chrischdi in #692 Fix crd flattening for</p></blockquote>

生成される CRD のマニフェストが、これまでは生成するたびに順序が変化していたのですが、ちゃんとソートして出力されるようになりました。
しかし、Webhook の設定に関して同様の問題がまだ残っているため、Neco チームとして Issue を投げて対応しています。

- [https://github.com/kubernetes-sigs/controller-tools/issues/730](https://github.com/kubernetes-sigs/controller-tools/issues/730)

### Stern v1.22.0

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/stern/stern/releases/tag/v1.22.0">Release v1.22.0 · stern/stern</a></h4><p>You can now use the following two new output modes: extjson is an extended json mode where the whole output is embeded in json and the namespace/pod/container values are color-coded as in the default mode. ppextjson is the same as the above with pretty-print, so each field is on its own line.</p></blockquote>

ログが JSON 形式で出力できるようになりました。
ログ解析したいときに便利そうですね。

## 🛠️ Tools, Frameworks, Libraries

### viddy

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/sachaos/viddy">GitHub - sachaos/viddy: 👀 A modern watch command. Time machine and pager etc.</a></h4><p>Modern watch command. Viddy well, gopher. Viddy well. Basic features of original watch command. Execute command periodically, and display the result. color output. diff highlight. Time machine mode. 😎 Rewind like video. Go to the past, and back to the future. See output in pager. Vim like keymaps. Search text.</p></blockquote>

kubectl の出力を watch するときに便利なツールです。
変化のあった箇所に色をつけて表示してくれたり、変更履歴を保持してあとから差分を確認できたり、なかなか便利そうです。

### Debugging Large and Complex Dockerfiles Gets Easier with Buildg

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://www.infoq.com/news/2022/09/debug-dockerfiles-buildg/">Debugging Large and Complex Dockerfiles Gets Easier with Buildg</a></h4><p>Kohei Tokunaga has released buildg - an interactive tool for debugging Dockerfiles. The motivation for the project is to provide an easy-to-use interactive tool to inspect this build process. The tool also containers support for debugging Dockerfiles directly from inside several popular IDEs (Integrated Developer Environments), such as VS Code, Emacs and Neovim.</p></blockquote>

Dockerfile を対話的にデバッグするためのツールです。
ブレイクポイントを張って実行を止めたり、ステップ実行したり、任意のコマンドを実行したりできるようです。
VS Code との連係もできるようで、なかなか便利そうですね。

## あとがき

Neco Weekly を [Zenn の パブリケーション機能](https://info.zenn.dev/about-publication) に移行したいと考えていたのですが、残念ながらクローズドβは外れてしまったようです。
正式リリースを楽しみに待ってます。
