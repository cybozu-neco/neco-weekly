# Neco Weekly (2022-09-01å·)

ã‚µã‚¤ãƒœã‚¦ã‚º Neco ãƒãƒ¼ãƒ ã§ã¯ã€ Neco Weekly ã¨ã„ã†ã€Œæœ€è¿‘æ°—ã«ãªã‚‹ Cloud Native é–¢é€£ã®ãƒã‚¿ã‚’å…±æœ‰ã™ã‚‹ä¼šã€ã‚’ç¤¾å†…ã§é–‹å‚¬ã—ã¦ã„ã¾ã™ã€‚
æœ¬è¨˜äº‹ã¯å…±æœ‰ä¼šã®ä¸­ã§ç´¹ä»‹ã—ãŸãƒã‚¿ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

ä»Šå›ã¯ç¬¬6å›ç›®ã®è¨˜äº‹ã¨ãªã‚Šã¾ã™ã€‚

## ğŸ“š å…ˆé€±å·ã®è£œè¶³

### cgroup v2 ã® memory.high ã®æŒ™å‹•ã«ã¤ã„ã¦

[å…ˆé€±å·](../08/2022-08-26.md) ã§ [QoS Memory](https://kubernetes.io/blog/2021/11/26/qos-memory-resources/) ã®è©±ã‚’ã—ãŸéš›ã«ã€cgroup v2 ã® `memory.high` ã®æŒ™å‹•ãŒã‚ˆãåˆ†ã‹ã‚‰ãªã„ã­ã¨ã„ã†è©±ã«ãªã£ãŸã®ã§ã™ãŒã€ç¤¾å†…ã®äººã«å‚è€ƒã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ•™ãˆã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚

- [memcontrol.c](https://github.com/torvalds/linux/blob/c5e4d5e99162ba8025d58a3af7ad103f155d2df7/mm/memcontrol.c#L2494-L2571)
- [timer.c](https://github.com/torvalds/linux/blob/a6b450573b912316ad36262bfc70e7c3870c56d1/kernel/time/timer.c#L1865-L1895)

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ç¢ºä¿ã—ãŸãƒ¡ãƒ¢ãƒªãŒ `memory.high` ã‚’è¶…ãˆãŸé‡ã«å¿œã˜ã¦ã€ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãŒå‰²ã‚Šå½“ã¦ã‚‹ CPU æ™‚é–“ã«ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’èª²ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿ã—ç¶šã‘ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã‚‹æ™‚é–“ã‚’æ¸›ã‚‰ã—ã€ãƒ¡ãƒ¢ãƒªå›åé€Ÿåº¦ã¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒ `memory.high` ä»¥ä¸‹ã«åã¾ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ãªãŠã€Linux ã®ãƒ¡ãƒ¢ãƒªç®¡ç†æ©Ÿèƒ½ã«é–¢ã—ã¦ã¯ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’èª­ã‚“ã§ãŠãã¨ã‚ˆã•ãã†ã§ã™ã€‚

- [The Linux kernel userâ€™s and administratorâ€™s guide Â» Memory Management Â» Concepts overview](https://www.kernel.org/doc/html/latest/admin-guide/mm/concepts.html)

### PodSecurity Admission

[å…ˆé€±å·](../08/2022-08-26.md) ã§ã€Neco ãƒãƒ¼ãƒ ã§ã¯ PodSecurityPolicy ã®ä»£æ›¿ã¨ã—ã¦å…¬å¼ã® PodSecurity Admission ã‚’åˆ©ç”¨ã›ãšã€è‡ªä½œã®ã‚‚ã®ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã¨ã„ã†è©±ã‚’ã—ã¾ã—ãŸã€‚
å…¬å¼ã® PodSecurity Admission ã¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒé›£ã—ã„ãŸã‚è‡ªä½œã®ã‚‚ã®ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€å…¬å¼ãƒ–ãƒ­ã‚°ã§ã‚‚ä»¥ä¸‹ã®ã‚ˆã†ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

> For more sophisticated use cases, you might need a third-party solution that can be easily combined with Pod Security Admission.
> 
> [PodSecurityPolicy: The Historical Context](https://kubernetes.io/blog/2022/08/23/podsecuritypolicy-the-historical-context/)

è¤‡é›‘ãªãƒãƒªã‚·ãƒ¼ã‚’æ‰±ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ„ãƒ¼ãƒ«ã¨çµ„ã¿åˆã‚ã›ãŸã‚Šã€è‡ªä½œãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ãŸã‚Šã™ã‚‹ã®ã¯æ­£ã—ã„æ–¹é‡ã ã¨è¨€ãˆãã†ã§ã™ã€‚

## ğŸ‘€ Notable PRs

### Ignore non-semantic changes to objects

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/kubernetes/kubernetes/pull/106388">Ignore non-semantic changes to objects by alexzielenski Â· Pull Request #106388 Â· kubernetes/kubernetes</a></h4><p>What type of PR is this? /kind bug What this PR does / why we need it: Ignores changes that only affect the timestamp in the managed fields. That can happen when someone merely updates a Quantity from 1024 to 1Ki or when accidentally removing a value that was a default.</p></blockquote>

Kubernetes ã§ Server-Side Apply æ–¹å¼ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°ã™ã‚‹éš›ã«ã€æ„å‘³çš„ã«ã¯å·®åˆ†ãŒãªã„å ´åˆã§ã‚‚ãƒªã‚½ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œã¦ã—ã¾ã„ã€ç„¡é§„ã« Reconciliation ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¦ã—ã¾ã†ã¨ã„ã†å•é¡ŒãŒã‚ã£ãŸã®ã§ã™ãŒã€ãã‚ŒãŒä¿®æ­£ã•ã‚ŒãŸã‚ˆã†ã§ã™ã€‚

Neco ãƒãƒ¼ãƒ ã§ã¯ã“ã®å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®è¨˜äº‹ã§ç´¹ä»‹ã—ã¦ã„ã‚‹ã‚ˆã†ã«ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§æ„å‘³çš„ãªå¤‰æ›´ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã—ãŸã€‚

- [Kubernetesã§Server Side Applyã™ã‚‹ã¨ãã«Clientã§å·®åˆ†è¨ˆç®—ã—ãŸã„](https://zenn.dev/zoetro/articles/85cdfe35ccba02)

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯å‡¦ç†ãŒä¸è¦ã«ãªã‚Œã°ã€ã‚³ãƒ¼ãƒ‰ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹ã®ã§ã‚ã‚ŠãŒãŸã„ã§ã™ã­ã€‚

## ğŸ‘€ Notable Articles

### Kubernetes Version 1.25: An Overview

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://blog.aquasec.com/kubernetes-version-1.25">Kubernetes Version 1.25: An Overview</a></h4><p>Kubernetes Version 1.25 was released with 40 new enhancements including 13 Stable, 10 Beta, 15 Alpha, and 2 Deprecated. Join us as we present some of the notable features in this release, apply security with the Pod Security Admission (PSA), validate whether your cluster is using containerd, and give an overview of the features.</p></blockquote>

Aqua ç¤¾ã«ã‚ˆã‚‹ Kubernetes 1.25 ã«é–¢ã™ã‚‹è¨˜äº‹ã§ã™ã€‚

ã“ã®è¨˜äº‹ã®ä¸­ã§ã€Neco ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®æ›¸ã„ãŸ [Five Things to Prepare for Cgroup v2 with Kubernetes](https://blog.kintone.io/entry/2022/03/08/170206) ã¨ã„ã†ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
ã“ã®ã‚ˆã†ã«å…¬é–‹ã—ãŸè‹±èªãƒ–ãƒ­ã‚°ãŒæµ·å¤–ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«èª­ã‚“ã§ã‚‚ã‚‰ãˆã‚‹ã¨ã¨ã¦ã‚‚å¬‰ã—ã„ã§ã™ã­ã€‚

### 10 Things I wish Iâ€™d known before building a Kubernetes CRD controller

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://omerxx.medium.com/10-things-i-wish-id-known-before-building-a-kubernetes-crd-controller-4170c425543e">10 Things I wish I'd known before building a Kubernetes CRD controller</a></h4><p>Well I didn't even know there was an axe... K8s resources, in that context, are one heck of a tree to chop. You better come ready to work. I hope that this information will find the axe for someone out...</p></blockquote>

Kubernetes ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’é–‹ç™ºã™ã‚‹å‰ã«çŸ¥ã£ã¦ãŠããŸã‹ã£ãŸ10ã®ã“ã¨ã¨ã„ã†è¨˜äº‹ãªã‚“ã§ã™ãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã‚€éš›ã®æ³¨æ„ç‚¹ã‚„ã€Dynamic Client ã®ä½¿ã„æ–¹ãªã©å°‘ã—çã—ã„ãƒã‚¿ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¦é¢ç™½ã‹ã£ãŸã§ã™ã€‚

ãªãŠã€Dynamic Client ã®ä½¿ã„æ–¹ã«é–¢ã—ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚

- [An example of using dynamic client of k8s.io/client-go](https://ymmt2005.hatenablog.com/entry/2020/04/14/An_example_of_using_dynamic_client_of_k8s.io/client-go)

ã¡ãªã¿ã«ã€Neco ãƒãƒ¼ãƒ ã«ã‚ˆã‚‹ Kubernetes Operator é–‹ç™ºã§å¾—ãŸçŸ¥è¦‹ã¯ä»¥ä¸‹ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã«ã¾ã¨ã¾ã£ã¦ã„ã‚‹ã®ã§ã€ã‚ˆã‚ã—ã‘ã‚Œã°å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://speakerdeck.com/zoetrope/kubernetesoperetafalseantipatan-besutopurakuteisu">Kubernetesã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã®ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼†ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</a></h4><p>CloudNative Days Tokyo 2021ã®ç™ºè¡¨è³‡æ–™ã§ã™ã€‚ https://event.cloudnativedays.jp/cndt2021/talks/1207 è£œè¶³è³‡æ–™ https://git.io/operator-bestpractice</p></blockquote>

### satlinuxtube

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://www.youtube.com/watch?v=0okzTgJ7-vs">ãã®48 Kubernetesã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«</a></h4><p>Kubernetesã®ã‚¯ãƒ©ã‚¹ã‚¿ã®çŠ¶æ…‹ã‚’ã‚ã‚‹ã¹ãå§¿ã«ä¿ã¤ãŸã‚ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¨ã„ã†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã¯å¾“æ¥å‹ã®ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚ã“ã®å‹•ç”»ã§ã¯Kubernetesã®åŸºæœ¬çš„ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ç´¹ä»‹ã—ãŸå¾Œã«ã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã®æ–­ç‰‡ã‚’è¦‹ãªãŒã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚ ãƒ†ã‚­ã‚¹ãƒˆ ...</p></blockquote>

[ã¤ãã£ã¦å­¦ã¶Kubebuilder](https://zoetrope.github.io/kubebuilder-training/)ã‚’é¡Œæã¨ã—ã¦ã€Kubernetes ã®åŸºæœ¬çš„ãªè©±ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã¤ãã‚Šæ–¹ã¾ã§è§£èª¬ã—ã¦ã„ã‚‹å‹•ç”»ã§ã™ã€‚
æ–‡ç« ã ã‘ã§ã¯ç†è§£ã—ã«ãã„å ´åˆã‚‚ã€å‹•ç”»ã§è§£èª¬ã—ã¦ãã‚Œã‚‹ã¨ç†è§£ã®åŠ©ã‘ã«ãªã‚Šã¾ã™ã­ã€‚

### Argo CRDs and Kustomize: The Problem of Patching Lists

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/Hsn723/container-tag-exists">GitHub - Hsn723/container-tag-exists: Query the Docker Registry API v2 to check if an image tag exists.</a></h4><p>Check whether a container image with the given tag exists by querying the Registry API v2. In principle, any registry implementing the Docker Registry API v2 should be supported, but this has only been confirmed with ghcr.io and quay.io. Install from releases or via go install go install github.com/Hsn723/container-tag-exists@latest container-tag-exists IMAGE TAG If IMAGE:TAG exists, this simply outputs found.</p></blockquote>

Kustomize ã§ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã® Strategic Merge Patch ã‚’ãŠã“ãªã†éš›ã«ã€ãƒªã‚¹ãƒˆãŒã†ã¾ããƒãƒ¼ã‚¸ã§ããªã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ã€Kustomize ãŒå¯¾è±¡ã®ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒã‚’æŒã£ã¦ã„ãªã„ãŸã‚ã«ç™ºç”Ÿã™ã‚‹å•é¡Œã§ã™ã€‚ï¼ˆãƒªã‚¹ãƒˆã®è¦ç´ ã®ã©ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚­ãƒ¼ã«ã—ã¦ãƒãƒ¼ã‚¸ã™ã‚Œã°ã„ã„ã®ã‹åˆ¤æ–­ã§ããªã„ãŸã‚ï¼‰

ãã“ã§ã“ã®è¨˜äº‹ã§ã¯ã€openapi-gen ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ CRD ã‹ã‚‰ go ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãã“ã‹ã‚‰ OpenAPI å½¢å¼ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å‡ºåŠ›ã—ã€ãã‚Œã‚’ Kustomize ã«æ¸¡ã™ã“ã¨ã§æ­£ã—ããƒãƒ¼ã‚¸ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

ãªã‹ãªã‹æ‰‹é–“ã®ã‹ã‹ã‚‹æ–¹æ³•ãªã®ã§ã€ã“ã®è¨˜äº‹ã®ä¸­ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã« Kubernetes ã‚„ Kustomize å´ã§å¯¾å¿œã—ã¦ã»ã—ã„ã§ã™ã­ã€‚

## ğŸ› ï¸ Tools

### container-tag-exists

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/Hsn723/container-tag-exists">GitHub - Hsn723/container-tag-exists: Query the Docker Registry API v2 to check if an image tag exists.</a></h4><p>Check whether a container image with the given tag exists by querying the Registry API v2. In principle, any registry implementing the Docker Registry API v2 should be supported, but this has only been confirmed with ghcr.io and quay.io. Install from releases or via go install go install github.com/Hsn723/container-tag-exists@latest container-tag-exists IMAGE TAG If IMAGE:TAG exists, this simply outputs found.</p></blockquote>

ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«æŒ‡å®šã—ãŸã‚¿ã‚°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
Neco ãƒãƒ¼ãƒ ã§ã¯ã€CI ã§ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹éš›ã«ã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯ã‚’ãŠã“ãªã†ã“ã¨ãŒã‚ˆãã‚ã‚‹ã®ã§ã€ã“ã†ã„ã†ãƒ„ãƒ¼ãƒ«ãŒã‚ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚

## ã‚ã¨ãŒã

ä»Šé€±ã¯ã‚µãƒãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã®èª²é¡Œã®ä¸­ã§ã€Kubernetes ã® Server-Side Apply ã¨ Client-Side Apply ãŒæ··ã˜ã£ãŸã¨ãã®æŒ™å‹•ã«æ‚©ã¾ã•ã‚Œã¾ã—ãŸã€‚
ã¯ã‚„ã kubectl ã‚„ Argo CD ãªã©ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ Server-Side Apply ã‚’åˆ©ç”¨ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã„ã„ãªã‚ã€‚
