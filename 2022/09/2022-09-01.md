# Neco Weekly (2022-09-01号)

サイボウズ Neco チームでは、 Neco Weekly という「最近気になる Cloud Native 関連のネタを共有する会」を社内で開催しています。
本記事は共有会の中で紹介したネタをまとめたものです。

今回は第6回目の記事となります。

## 📚 先週号の補足

### cgroup v2 の memory.high の挙動について

[先週号](../08/2022-08-26.md) で [QoS Memory](https://kubernetes.io/blog/2021/11/26/qos-memory-resources/) の話をした際に、cgroup v2 の `memory.high` の挙動がよく分からないねという話になったのですが、社内の人に参考となるコードを教えてもらいました。

- [memcontrol.c](https://github.com/torvalds/linux/blob/c5e4d5e99162ba8025d58a3af7ad103f155d2df7/mm/memcontrol.c#L2494-L2571)
- [timer.c](https://github.com/torvalds/linux/blob/a6b450573b912316ad36262bfc70e7c3870c56d1/kernel/time/timer.c#L1865-L1895)

このコードでは、確保したメモリが `memory.high` を超えた量に応じて、タスクスケジューラが割り当てる CPU 時間にペナルティを課しているようです。
これにより、メモリを確保し続けるタスクがスケジュールされる時間を減らし、メモリ回収速度とのバランスを取り、メモリ使用量が `memory.high` 以下に収まることを期待しているようです。

なお、Linux のメモリ管理機能に関しては、以下のページを読んでおくとよさそうです。

- [The Linux kernel user’s and administrator’s guide » Memory Management » Concepts overview](https://www.kernel.org/doc/html/latest/admin-guide/mm/concepts.html)

### PodSecurity Admission

[先週号](../08/2022-08-26.md) で、Neco チームでは PodSecurityPolicy の代替として公式の PodSecurity Admission を利用せず、自作のものを利用しているという話をしました。
公式の PodSecurity Admission はプロファイルのカスタマイズが難しいため自作のものを使っているのですが、公式ブログでも以下のように説明されていました。

> For more sophisticated use cases, you might need a third-party solution that can be easily combined with Pod Security Admission.
> 
> [PodSecurityPolicy: The Historical Context](https://kubernetes.io/blog/2022/08/23/podsecuritypolicy-the-historical-context/)

複雑なポリシーを扱うユースケースでは、サードパーティーツールと組み合わせたり、自作ツールを作ったりするのは正しい方針だと言えそうです。

## 👀 Notable PRs

### Ignore non-semantic changes to objects

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/kubernetes/kubernetes/pull/106388">Ignore non-semantic changes to objects by alexzielenski · Pull Request #106388 · kubernetes/kubernetes</a></h4><p>What type of PR is this? /kind bug What this PR does / why we need it: Ignores changes that only affect the timestamp in the managed fields. That can happen when someone merely updates a Quantity from 1024 to 1Ki or when accidentally removing a value that was a default.</p></blockquote>

Kubernetes で Server-Side Apply 方式でリソースを更新する際に、意味的には差分がない場合でもリソースが更新されてしまい、無駄に Reconciliation がトリガーされてしまうという問題があったのですが、それが修正されたようです。

Neco チームではこの問題を回避するために、以下の記事で紹介しているように、クライアントサイドで意味的な変更があるかどうかをチェックしていました。

- [KubernetesでServer Side ApplyするときにClientで差分計算したい](https://zenn.dev/zoetro/articles/85cdfe35ccba02)

クライアントサイドでの差分チェック処理が不要になれば、コードもシンプルになるのでありがたいですね。

## 👀 Notable Articles

### Kubernetes Version 1.25: An Overview

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://blog.aquasec.com/kubernetes-version-1.25">Kubernetes Version 1.25: An Overview</a></h4><p>Kubernetes Version 1.25 was released with 40 new enhancements including 13 Stable, 10 Beta, 15 Alpha, and 2 Deprecated. Join us as we present some of the notable features in this release, apply security with the Pod Security Admission (PSA), validate whether your cluster is using containerd, and give an overview of the features.</p></blockquote>

Aqua 社による Kubernetes 1.25 に関する記事です。

この記事の中で、Neco チームメンバーの書いた [Five Things to Prepare for Cgroup v2 with Kubernetes](https://blog.kintone.io/entry/2022/03/08/170206) というブログ記事が紹介されていました。
このように公開した英語ブログが海外のエンジニアに読んでもらえるととても嬉しいですね。

### 10 Things I wish I’d known before building a Kubernetes CRD controller

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://omerxx.medium.com/10-things-i-wish-id-known-before-building-a-kubernetes-crd-controller-4170c425543e">10 Things I wish I'd known before building a Kubernetes CRD controller</a></h4><p>Well I didn't even know there was an axe... K8s resources, in that context, are one heck of a tree to chop. You better come ready to work. I hope that this information will find the axe for someone out...</p></blockquote>

Kubernetes のコントローラーを開発する前に知っておきたかった10のことという記事なんですが、カスタムリソースにメタデータを埋め込む際の注意点や、Dynamic Client の使い方など少し珍しいネタが紹介されていて面白かったです。

なお、Dynamic Client の使い方に関しては以下の記事が分かりやすいのでおすすめです。

- [An example of using dynamic client of k8s.io/client-go](https://ymmt2005.hatenablog.com/entry/2020/04/14/An_example_of_using_dynamic_client_of_k8s.io/client-go)

ちなみに、Neco チームによる Kubernetes Operator 開発で得た知見は以下のスライドにまとまっているので、よろしければ参考にしてみてください。

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://speakerdeck.com/zoetrope/kubernetesoperetafalseantipatan-besutopurakuteisu">Kubernetesオペレータのアンチパターン＆ベストプラクティス</a></h4><p>CloudNative Days Tokyo 2021の発表資料です。 https://event.cloudnativedays.jp/cndt2021/talks/1207 補足資料 https://git.io/operator-bestpractice</p></blockquote>

### satlinuxtube

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://www.youtube.com/watch?v=0okzTgJ7-vs">その48 Kubernetesのコントローラのプログラミングモデル</a></h4><p>Kubernetesのクラスタの状態をあるべき姿に保つためのコントローラというプログラムが存在します。このコントローラのプログラミングモデルは従来型のイベント駆動プログラムとは異なります。この動画ではKubernetesの基本的なコンセプトを紹介した後に、実際のコードの断片を見ながらコントローラのプログラミングモデルについて紹介します。 テキスト ...</p></blockquote>

[つくって学ぶKubebuilder](https://zoetrope.github.io/kubebuilder-training/)を題材として、Kubernetes の基本的な話からカスタムコントローラーのつくり方まで解説している動画です。
文章だけでは理解しにくい場合も、動画で解説してくれると理解の助けになりますね。

### Argo CRDs and Kustomize: The Problem of Patching Lists

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/Hsn723/container-tag-exists">GitHub - Hsn723/container-tag-exists: Query the Docker Registry API v2 to check if an image tag exists.</a></h4><p>Check whether a container image with the given tag exists by querying the Registry API v2. In principle, any registry implementing the Docker Registry API v2 should be supported, but this has only been confirmed with ghcr.io and quay.io. Install from releases or via go install go install github.com/Hsn723/container-tag-exists@latest container-tag-exists IMAGE TAG If IMAGE:TAG exists, this simply outputs found.</p></blockquote>

Kustomize でカスタムリソースの Strategic Merge Patch をおこなう際に、リストがうまくマージできないという問題があります。
これは、Kustomize が対象のカスタムリソースのスキーマを持っていないために発生する問題です。（リストの要素のどのフィールドをキーにしてマージすればいいのか判断できないため）

そこでこの記事では、openapi-gen というツールを使って CRD から go のファイルを生成し、そこから OpenAPI 形式のスキーマを出力し、それを Kustomize に渡すことで正しくマージする方法を紹介しています。

なかなか手間のかかる方法なので、この記事の中で紹介されているように Kubernetes や Kustomize 側で対応してほしいですね。

## 🛠️ Tools

### container-tag-exists

<blockquote class="embedly-card" data-card-controls="0"><h4><a href="https://github.com/Hsn723/container-tag-exists">GitHub - Hsn723/container-tag-exists: Query the Docker Registry API v2 to check if an image tag exists.</a></h4><p>Check whether a container image with the given tag exists by querying the Registry API v2. In principle, any registry implementing the Docker Registry API v2 should be supported, but this has only been confirmed with ghcr.io and quay.io. Install from releases or via go install go install github.com/Hsn723/container-tag-exists@latest container-tag-exists IMAGE TAG If IMAGE:TAG exists, this simply outputs found.</p></blockquote>

コンテナレジストリに指定したタグのイメージが存在するかどうかチェックしてくれるツールです。
Neco チームでは、CI でコンテナイメージをビルドする際にタグのチェックをおこなうことがよくあるので、こういうツールがあると助かります。

## あとがき

今週はサマーインターンの課題の中で、Kubernetes の Server-Side Apply と Client-Side Apply が混じったときの挙動に悩まされました。
はやく kubectl や Argo CD などがデフォルトで Server-Side Apply を利用してくれるようになるといいなあ。
